{{define "title"}}Launch a Survey{{end}}

{{define "body"}}
<h1>Launch a survey</h1>
<div class="field-wrap">

<form action="" method="POST" xmlns="http://www.w3.org/1999/html">

    <div class="field-container">
        <label for="schema">Schemas</label>
        <select id="schema" name="schema" class="qa-select-schema" onchange="loadMetadata()">
            <option selected disabled>Select Schema</option>
            <optgroup label="Business Surveys">
                {{range .Schemas.Business}}
                    <option name="{{.Name}}" value="{{.Name}}">{{.Name}}</option>
                {{end}}
            </optgroup>
            <optgroup label="Census Surveys">
                {{range .Schemas.Census}}
                    <option name="{{.Name}}" value="{{.Name}}">{{.Name}}</option>
                {{end}}
            </optgroup>
            <optgroup label="Social Surveys">
                {{range .Schemas.Social}}
                    <option name="{{.Name}}" value="{{.Name}}">{{.Name}}</option>
                {{end}}
            </optgroup>
            <optgroup label="Test Surveys">
                {{range .Schemas.Test}}
                    <option name="{{.Name}}" value="{{.Name}}">{{.Name}}</option>
                {{end}}
            </optgroup>
            <optgroup label="Other Surveys">
                {{range .Schemas.Other}}
                    <option name="{{.Name}}" value="{{.Name}}">{{.Name}}</option>
                {{end}}
            </optgroup>
        </select>
    </div>

    <h3>Survey Metadata</h3>
    <div id="survey_metadata">
        <p>--- Metadata fields will be loaded when you select a schema ---</p>
    </div>

    <h3>Required Data</h3>

    <div class="field-container">
        <label for="ru_ref">RU Ref</label>
        <span>
            <input id="ru_ref" name="ru_ref" type="text" class="qa-ru-ref">
            <img onclick="ruref('ru_ref')" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iNTEycHgiIGlkPSJMYXllcl8xIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgd2lkdGg9IjUxMnB4IiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48Zz48cGF0aCBkPSJNMjU2LDM4NC4xYy03MC43LDAtMTI4LTU3LjMtMTI4LTEyOC4xYzAtNzAuOCw1Ny4zLTEyOC4xLDEyOC0xMjguMVY4NGw5Niw2NGwtOTYsNTUuN3YtNTUuOCAgIGMtNTkuNiwwLTEwOC4xLDQ4LjUtMTA4LjEsMTA4LjFjMCw1OS42LDQ4LjUsMTA4LjEsMTA4LjEsMTA4LjFTMzY0LjEsMzE2LDM2NC4xLDI1NkgzODRDMzg0LDMyNywzMjYuNywzODQuMSwyNTYsMzg0LjF6Ii8+PC9nPjwvc3ZnPg==">
        </span>
    </div>

    <div class="field-container">
        <label for="collection_exercise_sid">Collection Exercise SID</label>
        <span>
            <input id="collection_exercise_sid" name="collection_exercise_sid" type="text" class="qa-collection-sid">
            <img onclick="uuid('collection_exercise_sid')" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iNTEycHgiIGlkPSJMYXllcl8xIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgd2lkdGg9IjUxMnB4IiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48Zz48cGF0aCBkPSJNMjU2LDM4NC4xYy03MC43LDAtMTI4LTU3LjMtMTI4LTEyOC4xYzAtNzAuOCw1Ny4zLTEyOC4xLDEyOC0xMjguMVY4NGw5Niw2NGwtOTYsNTUuN3YtNTUuOCAgIGMtNTkuNiwwLTEwOC4xLDQ4LjUtMTA4LjEsMTA4LjFjMCw1OS42LDQ4LjUsMTA4LjEsMTA4LjEsMTA4LjFTMzY0LjEsMzE2LDM2NC4xLDI1NkgzODRDMzg0LDMyNywzMjYuNywzODQuMSwyNTYsMzg0LjF6Ii8+PC9nPjwvc3ZnPg==">
        </span>
    </div>

    <div class="field-container">
        <label for="case_id">Case ID</label>
        <span>
            <input id="case_id" name="case_id" type="text" class="qa-case_id">
            <img onclick="uuid('case_id')" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iNTEycHgiIGlkPSJMYXllcl8xIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgd2lkdGg9IjUxMnB4IiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48Zz48cGF0aCBkPSJNMjU2LDM4NC4xYy03MC43LDAtMTI4LTU3LjMtMTI4LTEyOC4xYzAtNzAuOCw1Ny4zLTEyOC4xLDEyOC0xMjguMVY4NGw5Niw2NGwtOTYsNTUuN3YtNTUuOCAgIGMtNTkuNiwwLTEwOC4xLDQ4LjUtMTA4LjEsMTA4LjFjMCw1OS42LDQ4LjUsMTA4LjEsMTA4LjEsMTA4LjFTMzY0LjEsMzE2LDM2NC4xLDI1NkgzODRDMzg0LDMyNywzMjYuNywzODQuMSwyNTYsMzg0LjF6Ii8+PC9nPjwvc3ZnPg==">
        </span>
    </div>

    <h3>Runner Data</h3>
    <div class="field-container">
        <label for="exp">Token Expiry (seconds)</label>
        <input id="exp" name="exp" type="text" value="1800" class="qa-token-expiry">
    </div>

    <div class="field-container">
        <label for="language_code">Language</label>
        <select id="language_code" name="language_code" class="qa-language-code">
            <option name="en" value="en">en</option>
            <option name="cy" value="cy">cy</option>
            <option name="" value="">&ltnot set&gt</option>
        </select>
    </div>

    <div class="field-container">
        <label for="roles">Roles</label>
        <select id="roles" name="roles" multiple="multiple" class="qa-roles">
            <option name="flusher" value="flusher">flusher</option>
            <option name="dumper" value="dumper" selected="selected">dumper</option>
        </select>
    </div>
     
    <div class="field-container">
        <label for="account_service_url">Account Service URL</label>
        <input id="account_service_url" name="account_service_url" type="text" value="{{.AccountServiceURL}}" class="qa-account_service_url">
    </div>
    
    <div class="field-container">
        <input type="submit" name="action_launch" value="Open Survey" class="qa-btn-submit-dev btn" id="submit-btn" disabled="disabled" />
        <input type="submit" name="action_flush" value="Flush Survey Data" class="qa-btn-submit-dev btn" id="flush-btn" disabled="disabled" />
    </div>

</form>
</div>

<script>

    function loadMetadata() {
        document.getElementById("submit-btn").disabled = true;
        document.getElementById("flush-btn").disabled = true;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
                if (this.status == 200) {

                    document.getElementById("survey_metadata").innerHTML = ""

                    var response = JSON.parse(this.responseText);

                    if (response.length > 0) {
                        for (var i = 0; i < response.length; i++) {
                            metadataField = response[i]

                            var defaultValue = metadataField['name'];

                            if (metadataField['validator'] == "date") {
                                var currentDate = new Date()
                                var defaultValue = currentDate.getFullYear() + "-" + ('0' + (currentDate.getMonth() + 1)).slice(-2) + "-" + ('0' + currentDate.getDate()).slice(-2)
                            }

                            if (metadataField['default'] != "") {
                                defaultValue = metadataField['default']
                            }

                            var metadataFieldHtml = ""

                            if (metadataField['validator'] == "boolean") {

                                metadataFieldHtml = "<div class=\"field-container\">" +
                                        "<label for=\"" + metadataField['name'] + "\">" + metadataField['name'] + "</label>" +
                                        "<input id=\"" + metadataField['name'] + "\" name=\"" + metadataField['name'] + "\" type=\"checkbox\" name=\"" + metadataField['name'] + "\" class=\"qa-" + metadataField['name'] + "\">" +
                                        "</div>"

                            } else if (metadataField['validator'] == "uuid") {

                                metadataFieldHtml = "<div class=\"field-container\">" +
                                        "<label for=\"" + metadataField['name'] + "\">" + metadataField['name'] + "</label>" +
                                        "<span>" +
                                        "<input id=\"" + metadataField['name'] + "\" name=\"" + metadataField['name'] + "\" type=\"text\" value=\"" + get_uuid() + "\" class=\"" + metadataField['name'] + "\">" +
                                        "<img onclick=\"uuid('" + metadataField['name'] + "')\" src=\"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iNTEycHgiIGlkPSJMYXllcl8xIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgd2lkdGg9IjUxMnB4IiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48Zz48cGF0aCBkPSJNMjU2LDM4NC4xYy03MC43LDAtMTI4LTU3LjMtMTI4LTEyOC4xYzAtNzAuOCw1Ny4zLTEyOC4xLDEyOC0xMjguMVY4NGw5Niw2NGwtOTYsNTUuN3YtNTUuOCAgIGMtNTkuNiwwLTEwOC4xLDQ4LjUtMTA4LjEsMTA4LjFjMCw1OS42LDQ4LjUsMTA4LjEsMTA4LjEsMTA4LjFTMzY0LjEsMzE2LDM2NC4xLDI1NkgzODRDMzg0LDMyNywzMjYuNywzODQuMSwyNTYsMzg0LjF6Ii8+PC9nPjwvc3ZnPg==\">" +
                                        "</span>" +
                                        "</div>"

                            } else {
                                metadataFieldHtml = "<div class=\"field-container\">" +
                                        "<label for=\"" + metadataField['name'] + "\">" + metadataField['name'] + "</label>" +
                                        "<input id=\"" + metadataField['name'] + "\" name=\"" + metadataField['name'] + "\" type=\"text\" value=\"" + defaultValue + "\" class=\"qa-" + metadataField['name'] + "\">" +
                                        "</div>"
                            }

                            document.getElementById("survey_metadata").innerHTML = document.getElementById("survey_metadata").innerHTML + metadataFieldHtml
                        }
                    } else {
                        document.getElementById("survey_metadata").innerHTML = "No metadata required for this survey"
                    }

                    document.getElementById("submit-btn").disabled = false;
                    document.getElementById("flush-btn").disabled = false;


                } else {
                    document.getElementById("survey_metadata").innerHTML = "Failed to load Schema Metadata"
                }
            }
        };
        xhttp.open("GET", "/metadata?schema=" + document.getElementById('schema').value , true);
        xhttp.send();
    }

    function get_uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      )
    }

    function uuid(el_id) {
      document.getElementById(el_id).value = get_uuid();
    }

    function ruref(el_id) {
      var result = '';
      var chars = '0123456789';
      for (var i = 11; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];
      var chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
      result += chars[Math.round(Math.random() * (chars.length - 1))];
      document.getElementById(el_id).value = result;
    }

    uuid('collection_exercise_sid');
    uuid('case_id');
    ruref('ru_ref');

</script>

{{end}}
